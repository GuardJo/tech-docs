> Java의 동시성 문제와 synchronized 키워드 정리

# 동시성 문제
**Multi Thread** 환경에서 다수의 **Thread**가 동일한 인스턴스나 필드 등의 자원을 읽거나 쓰는 등의 작업이 있을 경우, 기존 시나리오와 맞지 않는 결과를 발생시킬 수 있으며, 이를 **동시성 문제** 라고 한다.

```java
public class BankAccountV1 implements BankAccount {  
    private long balance; // 잔액
	...
    @Override  
    public boolean withdraw(long amount) {  
        if (amount > balance) {  
            Logger.log("잔액이 부족합니다. 출금 요청 금액 : " + amount + ", 계좌 잔액 : " + balance);  
            return false;  
        }  
  
        Logger.log("출금 요청 금액 : " + amount + ", 계좌 잔액 : " + balance);  
  
        try {  
            Thread.sleep(1000);  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
  
        balance -= amount;  
        Logger.log("출금 완료 : 출금 금액 : " + amount + ", 계좌 잔액 : " + balance);  
        return true;  
    }  
  
    @Override  
    public long getBalance() {  
        return balance;  
    }  
}
```

만약 위와 같이 특정 계정의 잔액을 조회 및 수정하는 등의 작업을 지닌 인스턴스를 여러 **Thread**에서 동일한 인스턴스를 참조하여 사용한다고 가정할 경우, 큰 문제가 발생할 수 있다.

`withdraw()` 메소드의 경우 해당 인스턴스의 `balance` 를 감소 시키는 작업이 존재하는데, 이 작업을 수행하기 전에 검증 로직이 삽입되어 있다. 일반 단일 **Thread** 상황에서는 정상적으로 `balance` 데이터를 조회하여 검증 후 계산 작업을 마치겠지만 만약 **Multu Thread** 환경일 경우, 원하는 작업이 정상적으로 수행되지 않을 수 있다.


```java
BankAccount account = new BankAccountV1(1000);  
  
Thread threadA = new Thread(new WithdrawTask(account, 800), "A");  
Thread threadB = new Thread(new WithdrawTask(account, 500), "B");  
  
threadA.start();  
threadB.start();  
  
threadA.join();  
threadB.join();  
  
Thread.sleep(500);  
  
Logger.log("Balance : " + account.getBalance()); // -300
```
만약 위와 같이 두 **Thread** 에서 동일한 값을 차감하도록 동시에 요청할 경우, 단일 **Thread**일 경우 `B Thread`는 검증 로직에 막혀야 하지만, 위와 같이 **Multi Thread** 환경에서는 둘 모두 검증 로직 진입 당시에는 `balance` 가 1000원이기에 검증 로직을 통과하게 되며, 이에 따라 이후 계산 시에도 동시에 차감되어 결과적으로 -300원이라는 비정상적인 값이 출력되게 된다.
- 해당 예시의 경우에는 [`volatile`](9.%20Volitile.md) 키워드를 사용하더라도 결국, 검증 및 계산 시점까지 **Main Memory** 에는 동일한 값으로 읽히기에 해결할 수 없음

위와 같은 상황이 `balance`라는 공유 자원을 사용하는 두 **Thread** 사이에 **동시성 문제**가 발생한 것이다.